---
export const prerender = false

import Layout from "$layouts/Layout.astro"
import { cards, getMembershipId, getUserGrimoire } from "$utils/helpers"
import CardPage from "$components/CardPage.astro"

const platform = Astro.params.platform as string
const username = Astro.params.username as string
const cardId = Astro.params.cardId as string

const card = cards[cardId]
if ((platform != "psn" && platform != "xbox") || !card)
	return Astro.redirect("/404")
const membershipType = platform == "xbox" ? 1 : 2
const membershipId = await getMembershipId(membershipType, username)
if (!membershipId) return Astro.redirect("/404")

const userGrimoire = await getUserGrimoire(membershipType, membershipId)
if (!userGrimoire) return Astro.redirect("/404")

const userCard = userGrimoire.cardCollection.find(
	(c) => c.cardId == card.cardId
)
// It's safe to assume there is only one bonus per card (I checked)
const userBonus = userGrimoire.bonuses.find((b) => b.cardId == card.cardId)
---

<Layout
	title={`${card.cardName} Â· Grimoire`}
	description={card.cardIntro || card.cardDescription || ""}
>
	<CardPage
		cardId={cardId}
		user={{
			card: userCard,
			bonus: userBonus,
			membershipType,
			membershipId,
			name: username,
			grimoire: userGrimoire,
		}}
	/>
</Layout>
